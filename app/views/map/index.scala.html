@()

@master.authenticated("Realtime Map") {

	
<script type="text/javascript" src="/assets/javascripts/socket.io.min.js"></script>
<script type="text/javascript" src="/assets/javascripts/jquery-1.7.1.min.js"></script>
    
<script type="text/javascript">
	
	
	
	
  var socket = io.connect('http://localhost:5000');
  
    socket.on('connect', function () {
      socket.on('mqtt', function (msg) {
        
    	var msgData = msg.payload;
    	var msgReplaced = msgData.replace(/_/g,'\"');
		var json_parsed = $.parseJSON(msgReplaced);
        
		if(existsDeviceRowID(json_parsed.DeviceId))
			updateDeviceRow(json_parsed);
		else
			addDeviceRow(json_parsed);
		
        console.log(msg.topic+' '+msg.payload);
     });
    });
    
    function setTopic(topic){	
    	$('table#devices > tbody').empty();
    	socket.emit('subscribe',{topic: topic});
    }
    
    function updateDeviceRow(infoObj){
    	var coords = $.trim(infoObj.Value),
    		deviceID = $.trim(infoObj.DeviceId),
			devicesTable = $('table#devices');
    	
    		devicesTable.find('tr#' + deviceID + ' > td.coords').text(coords);
    }
    
    function existsDeviceRowID(deviceID){
    	var devicesTable = $('table#devices');

    	if(devicesTable.find('tr#' + $.trim(deviceID)).size() == 1)
    		return true;
    	else
    		return false;
    }
    
    function addDeviceRow(infoObj){
    	var deviceId = $.trim(infoObj.DeviceId),
			coords = $.trim(infoObj.Value),
			devicesTable = $('table#devices'),
			newRow;
			
    		newRow = '<tr id="' + deviceId  + '">' +
    					'<td>' + (devicesTable.find('tbody > tr').size() + 1) + '</td>' + 
    					'<td><span class="label label-warning span2">Warning</span></td>' + 
    					'<td><i class="icon-road"></i>Diagnostics</td>' + 
    					'<td class="deviceID">' + deviceId + '</td>' +
    					'<td>COD_' + deviceId + '</td>' +
    	          		'<td></td>' +
    	          		'<td class="coords">' + coords + '</td>' + 
    	          	 '</tr>';
    	 	
    	   $(newRow).appendTo(devicesTable.children('tbody'));
    }

</script>





<div class="content span8">
  <h1>Real Time Remote devices logging</h1>
  <p class="lead">Here you can monitor in real time all the events generated by 
    devices on the field.</p>

    <h2>Query</h2>
    <form class="form">
      <div class="input-append">
        <input type="text" class="span5" id="topicSearchText">
        <button class="btn dropdown-toggle" data-toggle="dropdown">Options <span class="caret"></span></button>
        <button class="btn" id="setTopic">Search</button>
        <label class="checkbox"><input type="checkbox"> autoupdate</label>
      </div>
    </form>

    <table class="table table-bordered table-condensed table-striped table-hover span6" id="devices" style="width: 100%;">
      <thead>
        <tr>
          <th class="span1">#</th>
          <th class="span1">
            <div class="btn-group">
              <button class="btn btn-small">Severity</button>
              <button class="btn btn-small dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>
              <ul class="dropdown-menu">
                <li><a href="#"><span class="label label-important span2">Critical</span></a></li>
                <li><a href="#"><span class="label label-warning span2">Warning</span></a></li>
                <li><a href="#"><span class="label span2">Info</span></a></li>
                <li class="divider"></li>
                <li><a href="#">All</a></li>
              </ul>
            </div>
          </th>
          <th class="span3">
            <div class="btn-group">
              <button class="btn btn-small">Category</button>
              <button class="btn btn-small dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>
              <ul class="dropdown-menu">
                <li><a href="#"><i class="icon-map-marker"></i> Geospatial</a></li>
                <li><a href="#"><i class="icon-road"></i> Diagnostic</a></li>
                <li><a href="#"><i class="icon-check"></i> Configuration</a></li>
                <li><a href="#"><i class="icon-warning-sign"></i> User alerts</a></li>
                <li class="divider"></li>
                <li><a href="#">All</a></li>
              </ul>
            </div>
          </th>
          <th class="span2">
            <div class="btn-group">
              <button class="btn btn-small">Device Id</button>
              <button class="btn btn-small dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>
              <ul class="dropdown-menu">
                <li><a href="#">af127d36ee21</a></li>
                <li><a href="#">f127d36ee21e</a></li>
                <li><a href="#">127d36ee21d3</a></li>
                <li><a href="#">27d36ee21a33</a></li>
                <li><a href="#">7d36ee215e22</a></li>
              </ul>
            </div>
          </th>
          <th class="span2">Code</th>
          <th class="span5">Actions</th>
          <th class="span5">Data</th>
        </tr>
      </thead>
      <tbody>


        <!-- <tr id="DEVICE1" >
          <td>1</td>
          <td><span class="label label-warning span2">Warning</span></td>
          <td><i class="icon-road"></i> Diagnostics</td>
          <td>DEVICE1</td>
          <td>W00001</td>
          <td></td>
          <td id="DEVICE1"></td>
        </tr>
        
        <tr >
          <td>2</td>
          <td><span class="label label-warning span2">Warning</span></td>
          <td><i class="icon-road"></i> Diagnostics</td>
          <td>DEVICE2</td>
          <td>W00002</td>
          <td></td>
          <td id="DEVICE2"></td>
        </tr>
        -->
        
   
        
        
      
      </tbody>
    </table></div>
<script type="text/javascript">
$('button#setTopic').bind('click', 
		function(event){
			event.stopPropagation();
			event.preventDefault();
			
			if($.trim($(event.target).siblings('input#topicSearchText').val()).length > 0)
				setTopic($(event.target).siblings('input#topicSearchText').val());
		});
</script>

}